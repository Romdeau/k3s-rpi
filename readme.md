# Raspberry Pi K3S Setup

Kubernetes cluster on a Raspberry Pi 5 (8GB).

## Image Customisation

In the Raspberry Pi Imager application I set my username (and password), set my pubkey (which also disables password auth which is a nice touch). In my DHCP server I reserved the IP via the MAC Address of the Raspberry Pi.

## K3s

Seems from a casual browse of the interwebs that k3s is somewhat tailor made for the Raspberry Pi. It is a lightweight Kubernetes distribution thats optimised for edge computing and IoT, which is what our Raspberry Pi is.s

### Install

```bash
curl -sfL https://get.k3s.io | sh -
```

I did run into the error:

```bash
Failed to find memory cgroup, you may need to add "cgroup_memory=1 cgroup_enable=memory" to your linux cmdline (/boot/cmdline.txt on a Raspberry Pi)
```

But checking the `/boot/cmdline.txt` file, I found the message:

```
DO NOT EDIT THIS FILE

The file you are looking for has moved to /boot/firmware/cmdline.txt
```

So i updated `/boot/firmware/cmdline.txt` with `cgroup_memory=1 cgroup_enable=memory` and rebooted.

Post reboot running `journalctl -xeu k3s.service` showed that everything is running now. The `kubectl` command line requires me to use it with `sudo` which is odd. Turns out this is because the default config file is `/etc/rancher/k3s/k3s.yaml` which is owned by root.

Once this is complete I want to setup `kubectl` from my local environment to talk to my k3s node externally. To do this I've just plucked the config directly from the `/etc/rancher/k3s/k3s.yaml` file which then works and allows me to interact with the cluster from my local machine.

## Flux Setup

You should [look at the docs](https://fluxcd.io/flux/installation/), but if you're impatient:

```bash
curl -s https://fluxcd.io/install.sh | sudo bash
```

Flux does work on arm, my install uses about 400mb of RAM, which is relatively heavy, but not too bad for what we get here.

```bash
export GITHUB_TOKEN=<SNIP>
export GITHUB_USER=romdeau
export GITHUB_FLUX_REPO=k3s-rpi

flux bootstrap github \
  --components-extra=image-reflector-controller,image-automation-controller \
  --owner=$GITHUB_USER \
  --repository=$GITHUB_FLUX_REPO \
  --branch=main \
  --path=./clusters/rpi \
  --read-write-key
```

## Pihole

Taking an initial stab at this with [this helmchart by MoJo2600](https://github.com/MoJo2600/pihole-kubernetes)

```bash
helm repo add mojo2600 https://mojo2600.github.io/pihole-kubernetes/
helm repo update
helm search repo mojo2600/pihole --versions
```

At time of writing the newest chart is `2.26.1`